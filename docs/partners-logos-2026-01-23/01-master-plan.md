# Мастер-план восстановления функционала "Логотипы партнёров"

**Дата:** 2026-01-23  
**Версия:** 1.0  
**Статус:** Готов к реализации

## Обзор

Этот документ описывает пошаговый план восстановления полного функционала управления логотипами партнёров в админ-панели и их отображения на главной странице сайта.

## Цели проекта

1. ✅ Сохранение логотипов партнёров в базу данных
2. ✅ Загрузка изображений в файловую систему (не Data URI)
3. ✅ Отображение карусели логотипов на главной странице
4. ✅ Полный CRUD функционал в админ-панели
5. ✅ Автоматическая сортировка партнёров
6. ✅ Публичный API для получения активных партнёров

## Архитектура решения

### Компоненты системы

```
┌─────────────────────────────────────────────────────────────┐
│                     ГЛАВНАЯ СТРАНИЦА                         │
│  ┌────────────────────────────────────────────────────┐     │
│  │         PartnersCarousel Component                  │     │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐         │     │
│  │  │  Logo 1  │  │  Logo 2  │  │  Logo 3  │  ...    │     │
│  │  └──────────┘  └──────────┘  └──────────┘         │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            ↓ GET /api/partners
┌─────────────────────────────────────────────────────────────┐
│              PUBLIC API (partners/index.py)                  │
│  • Возвращает только активные партнёры                      │
│  • Сортировка по sort_order                                 │
│  • Без авторизации                                          │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                   DATABASE (partners)                        │
│  id | name | logo_url | website | sort_order | is_active   │
└─────────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────────┐
│         ADMIN API (admin-partner-logos/index.py)            │
│  • CRUD операции                                            │
│  • Требует авторизацию                                      │
│  • Автоматический sort_order                                │
└─────────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────────┐
│                    АДМИН ПАНЕЛЬ                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │           PartnersAdmin Component                   │     │
│  │  ┌──────────────────────────────────────────┐      │     │
│  │  │  PartnerForm (создание)                  │      │     │
│  │  │  1. Выбор файла                          │      │     │
│  │  │  2. Upload → /api/upload-image           │      │     │
│  │  │  3. Получить URL                         │      │     │
│  │  │  4. Сохранить → /api/admin-partner-logos │      │     │
│  │  └──────────────────────────────────────────┘      │     │
│  │  ┌──────────────────────────────────────────┐      │     │
│  │  │  PartnerCard (редактирование)            │      │     │
│  │  └──────────────────────────────────────────┘      │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│         UPLOAD API (upload-image/index.py)                  │
│  • Сохранение в /public/uploads/logos/                      │
│  • Генерация уникального имени (UUID)                       │
│  • Возврат публичного URL                                   │
└─────────────────────────────────────────────────────────────┘
```

## Этапы реализации

### Этап 1: Создание публичного API для партнёров

**Цель:** Создать endpoint для получения списка активных партнёров без авторизации

**Файлы:**
- `backend/partners/index.py` (создать)
- `backend/func2url.json` (обновить)

**Задачи:**
1. Создать новый endpoint `/api/partners`
2. Реализовать GET метод для получения активных партнёров
3. Добавить сортировку по `sort_order ASC`
4. Добавить фильтрацию `is_active = true`
5. Обновить маппинг в `func2url.json`

**Критерии приёмки:**
- ✅ GET `/api/partners` возвращает список активных партнёров
- ✅ Партнёры отсортированы по `sort_order`
- ✅ Не требуется авторизация
- ✅ Возвращает поля: `id, name, logo_url, website_url, display_order`

---

### Этап 2: Интеграция загрузки изображений

**Цель:** Использовать существующий `upload-image` endpoint для сохранения логотипов

**Файлы:**
- `src/hooks/useImageUpload.ts` (создать)
- `src/components/admin/PartnerForm.tsx` (обновить)
- `src/components/admin/PartnerCard.tsx` (обновить)
- `src/config/api.ts` (обновить)

**Задачи:**
1. Создать хук `useImageUpload` для загрузки изображений
2. Обновить `PartnerForm` для использования хука
3. Обновить `PartnerCard` для использования хука
4. Добавить валидацию размера файла (макс 2MB)
5. Добавить индикатор загрузки
6. Настроить режим `storage_type: 'local'` и `folder: 'logos'`

**Критерии приёмки:**
- ✅ Логотипы сохраняются в `/public/uploads/logos/`
- ✅ В БД сохраняется путь `/uploads/logos/uuid.ext`
- ✅ Есть превью перед загрузкой
- ✅ Есть индикатор процесса загрузки
- ✅ Валидация размера файла работает
- ✅ Поддерживаются форматы: PNG, JPG, SVG, WEBP

---

### Этап 3: Автоматическая сортировка

**Цель:** Автоматически назначать `sort_order` при создании партнёра

**Файлы:**
- `backend/admin-partner-logos/index.py` (обновить)
- `src/components/admin/PartnerForm.tsx` (обновить)

**Задачи:**
1. При создании партнёра автоматически вычислять `sort_order = MAX(sort_order) + 1`
2. Убрать поле `display_order` из формы создания
3. Добавить возможность изменения порядка в режиме редактирования
4. Опционально: добавить drag-and-drop для изменения порядка

**Критерии приёмки:**
- ✅ При создании `sort_order` назначается автоматически
- ✅ Можно изменить порядок в режиме редактирования
- ✅ Порядок сохраняется в БД
- ✅ Карусель отображает партнёров в правильном порядке

---

### Этап 4: Добавление карусели на главную страницу

**Цель:** Отобразить карусель логотипов партнёров на главной странице

**Файлы:**
- `src/pages/Index.tsx` (обновить)
- `src/components/PartnersCarousel.tsx` (проверить/обновить)

**Задачи:**
1. Импортировать `PartnersCarousel` в `Index.tsx`
2. Добавить компонент в нужное место на странице
3. Проверить корректность работы карусели
4. Настроить стили и анимацию
5. Добавить обработку ошибок загрузки

**Критерии приёмки:**
- ✅ Карусель отображается на главной странице
- ✅ Логотипы загружаются корректно
- ✅ Анимация работает плавно
- ✅ При клике на логотип открывается сайт партнёра
- ✅ Адаптивный дизайн работает на всех устройствах

---

### Этап 5: Улучшения UX и обработка ошибок

**Цель:** Улучшить пользовательский опыт и обработку ошибок

**Файлы:**
- `src/components/admin/PartnersAdmin.tsx` (обновить)
- `src/components/admin/PartnerForm.tsx` (обновить)
- `src/components/admin/PartnerCard.tsx` (обновить)

**Задачи:**
1. Добавить подтверждение удаления с деталями
2. Добавить валидацию URL сайта
3. Добавить превью логотипа в полном размере
4. Добавить возможность замены логотипа
5. Улучшить сообщения об ошибках
6. Добавить индикаторы состояния (loading, success, error)

**Критерии приёмки:**
- ✅ Все действия имеют визуальную обратную связь
- ✅ Ошибки отображаются понятными сообщениями
- ✅ Валидация работает корректно
- ✅ Можно заменить логотип без удаления партнёра

---

## Детальные спецификации

### 1. Структура данных

#### API Response (GET /api/partners)
```json
[
  {
    "id": 1,
    "name": "Яндекс",
    "logo_url": "/uploads/logos/uuid-123.png",
    "website_url": "https://yandex.ru",
    "display_order": 1,
    "is_active": true
  }
]
```

#### Upload Image Request
```json
{
  "image": "base64_encoded_string",
  "filename": "logo.png",
  "storage_type": "local",
  "folder": "logos"
}
```

#### Upload Image Response
```json
{
  "url": "/uploads/logos/uuid-123.png",
  "filename": "uuid-123.png",
  "type": "local"
}
```

### 2. Хук useImageUpload

```typescript
interface UseImageUploadOptions {
  folder?: string;
  maxSizeMB?: number;
  allowedTypes?: string[];
}

interface UseImageUploadReturn {
  uploadImage: (file: File) => Promise<string>;
  isUploading: boolean;
  error: string | null;
  progress: number;
}

function useImageUpload(options?: UseImageUploadOptions): UseImageUploadReturn
```

### 3. Валидация

**Размер файла:**
- Максимум: 2 MB
- Сообщение: "Размер файла не должен превышать 2 МБ"

**Типы файлов:**
- Разрешены: PNG, JPG, JPEG, SVG, WEBP
- Сообщение: "Разрешены только изображения: PNG, JPG, SVG, WEBP"

**URL сайта:**
- Формат: `https?://.*`
- Сообщение: "Введите корректный URL (начинается с http:// или https://)"

**Название:**
- Минимум: 2 символа
- Максимум: 100 символов
- Сообщение: "Название должно содержать от 2 до 100 символов"

### 4. Автоматический sort_order

**SQL запрос для получения следующего порядка:**
```sql
SELECT COALESCE(MAX(sort_order), 0) + 1 as next_order FROM partners
```

**Логика в backend:**
```python
# При POST запросе
if 'display_order' not in body or body['display_order'] is None:
    cur.execute('SELECT COALESCE(MAX(sort_order), 0) + 1 FROM partners')
    display_order = cur.fetchone()[0]
else:
    display_order = body['display_order']
```

### 5. Миграция существующих данных

**Проблема:** Если в БД уже есть партнёры с Data URI в `logo_url`

**Решение:**
1. Создать скрипт миграции `scripts/migrate-partner-logos.js`
2. Извлечь Data URI из БД
3. Сохранить как файлы в `/public/uploads/logos/`
4. Обновить `logo_url` в БД

**Скрипт миграции:**
```javascript
// scripts/migrate-partner-logos.js
const fs = require('fs');
const path = require('path');
const { Pool } = require('pg');

async function migratePartnerLogos() {
  const pool = new Pool({ connectionString: process.env.DATABASE_URL });
  
  const { rows } = await pool.query(
    "SELECT id, name, logo_url FROM partners WHERE logo_url LIKE 'data:%'"
  );
  
  for (const partner of rows) {
    // Извлечь base64 из Data URI
    const matches = partner.logo_url.match(/^data:([^;]+);base64,(.+)$/);
    if (!matches) continue;
    
    const [, mimeType, base64Data] = matches;
    const ext = mimeType.split('/')[1];
    const filename = `${partner.id}-${Date.now()}.${ext}`;
    const filepath = path.join(__dirname, '../public/uploads/logos', filename);
    
    // Сохранить файл
    fs.writeFileSync(filepath, Buffer.from(base64Data, 'base64'));
    
    // Обновить БД
    await pool.query(
      'UPDATE partners SET logo_url = $1 WHERE id = $2',
      [`/uploads/logos/${filename}`, partner.id]
    );
    
    console.log(`Migrated: ${partner.name}`);
  }
  
  await pool.end();
}

migratePartnerLogos().catch(console.error);
```

## Тестирование

### Тестовые сценарии

#### Сценарий 1: Создание партнёра
1. Открыть админ-панель → Контент → Логотипы партнёров
2. Нажать "Добавить партнёра"
3. Заполнить название: "Тестовый партнёр"
4. Заполнить сайт: "https://example.com"
5. Загрузить логотип (PNG, < 2MB)
6. Нажать "Сохранить"
7. **Ожидаемый результат:**
   - Партнёр появился в списке
   - Логотип отображается корректно
   - Файл сохранён в `/public/uploads/logos/`
   - В БД `logo_url` содержит путь `/uploads/logos/uuid.png`

#### Сценарий 2: Редактирование партнёра
1. Нажать "Редактировать" на существующем партнёре
2. Изменить название
3. Загрузить новый логотип
4. Нажать "Сохранить"
5. **Ожидаемый результат:**
   - Изменения сохранены
   - Новый логотип отображается
   - Старый файл можно удалить (опционально)

#### Сценарий 3: Удаление партнёра
1. Нажать "Удалить" на партнёре
2. Подтвердить удаление
3. **Ожидаемый результат:**
   - Партнёр удалён из списка
   - Запись удалена из БД
   - Файл логотипа остаётся (для истории)

#### Сценарий 4: Отображение на главной
1. Создать 3+ активных партнёра
2. Открыть главную страницу
3. **Ожидаемый результат:**
   - Карусель отображается
   - Логотипы анимируются
   - При клике открывается сайт партнёра
   - Порядок соответствует `sort_order`

#### Сценарий 5: Валидация
1. Попытаться загрузить файл > 2MB
2. **Ожидаемый результат:** Ошибка "Размер файла не должен превышать 2 МБ"
3. Попытаться загрузить .txt файл
4. **Ожидаемый результат:** Ошибка "Разрешены только изображения"
5. Попытаться сохранить без названия
6. **Ожидаемый результат:** Ошибка "Введите название партнёра"

### Чек-лист перед деплоем

- [ ] Все тесты пройдены
- [ ] Создана директория `/public/uploads/logos/` с правами на запись
- [ ] Выполнена миграция существующих Data URI (если есть)
- [ ] Обновлён `func2url.json`
- [ ] Проверена работа на dev окружении
- [ ] Проверена работа на мобильных устройствах
- [ ] Добавлены логи для отладки
- [ ] Документация обновлена

## Возможные проблемы и решения

### Проблема 1: Права доступа к файловой системе

**Симптомы:** Ошибка при сохранении файла

**Решение:**
```bash
mkdir -p /public/uploads/logos
chmod 755 /public/uploads/logos
```

### Проблема 2: Большой размер БД из-за Data URI

**Симптомы:** Медленные запросы, большой размер таблицы

**Решение:** Выполнить миграцию скриптом `migrate-partner-logos.js`

### Проблема 3: CORS ошибки при загрузке

**Симптомы:** Ошибка CORS в консоли браузера

**Решение:** Проверить заголовки в `upload-image/index.py`:
```python
'Access-Control-Allow-Origin': '*',
'Access-Control-Allow-Methods': 'POST, OPTIONS',
'Access-Control-Allow-Headers': 'Content-Type'
```

### Проблема 4: Карусель не отображается

**Симптомы:** Пустое место на главной странице

**Решение:**
1. Проверить консоль браузера на ошибки
2. Проверить что endpoint `/api/partners` возвращает данные
3. Проверить что есть активные партнёры (`is_active = true`)
4. Проверить что `PartnersCarousel` импортирован в `Index.tsx`

## Метрики успеха

1. **Функциональность:**
   - ✅ 100% CRUD операций работают
   - ✅ Карусель отображается на главной
   - ✅ Логотипы загружаются корректно

2. **Производительность:**
   - ✅ Время загрузки карусели < 1 сек
   - ✅ Размер БД не увеличивается от изображений
   - ✅ Плавная анимация (60 FPS)

3. **UX:**
   - ✅ Все действия имеют обратную связь
   - ✅ Понятные сообщения об ошибках
   - ✅ Интуитивный интерфейс

4. **Надёжность:**
   - ✅ Обработка всех ошибок
   - ✅ Валидация данных
   - ✅ Нет потери данных

## Следующие шаги

После завершения основного функционала можно добавить:

1. **Drag-and-drop сортировка** - изменение порядка перетаскиванием
2. **Массовые операции** - удаление/активация нескольких партнёров
3. **История изменений** - логирование всех действий
4. **Предпросмотр карусели** - в админ-панели
5. **Статистика кликов** - отслеживание переходов на сайты партнёров
6. **Категории партнёров** - группировка по типам
7. **Экспорт/импорт** - резервное копирование данных

## Заключение

Этот план обеспечивает полное восстановление функционала логотипов партнёров с улучшенной архитектурой, производительностью и пользовательским опытом.

Реализация разбита на 5 этапов, каждый из которых может быть выполнен независимо и протестирован отдельно.

Общее время реализации: 8-12 часов работы разработчика.

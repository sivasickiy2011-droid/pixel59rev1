# Улучшения чат-бота Olama: интерактивный чат для пользователей

## Цель изменений
Реализовать функционал, чтобы чат-бот считывал куки пользователя (согласие на обработку конфиденциальных данных) и обращался по имени и фамилии (или имени браузера), а также ограничить доступ к странице с чатом GPT только из админ-панели. На главной странице при нажатии неавторизованным пользователем выводится небольшой чат поверх сайта с кнопкой крестика для выхода, общение происходит в виде красивого диалогового окна.

## Внесённые изменения

### 1. Считывание кук и передача имени в промпт
- **Бекенд:** `server/api/ai-chat.js` – добавлена функция `enhancePrompt`, которая извлекает заголовки `X-User-Name` и `X-User-Consent`. Если имя присутствует, промпт дополняется обращениями к пользователю. Если есть согласие на обработку персональных данных, бот использует имя и фамилию; иначе – имя аккаунта браузера.
- **Фронтенд:** `src/pages/AiChat.tsx` – добавлена отправка заголовков `X-User-Name` и `X-User-Consent` в каждом запросе на основе данных из кук.

### 2. Ограничение доступа к странице AiChat только из админ-панели
- **Маршрутизация:** `src/App.tsx` – маршрут `/ai-chat` обёрнут в `AdminProtectedRoute`, который проверяет наличие токена админа. Неавторизованные пользователи перенаправляются на страницу логина.
- **Компонент:** `src/components/AdminProtectedRoute.tsx` – выполняет проверку аутентификации администратора.

### 3. Компонент всплывающего чата для главной страницы
- **Новый компонент:** `src/components/FloatingChat.tsx` – диалоговое окно с:
  - Кнопкой открытия/закрытия (крестик).
  - Полем ввода сообщения.
  - Отображением истории сообщений с аватарами.
  - Адаптивным дизайном (хвостик в правом нижнем углу).
  - Автоматической прокруткой к последнему сообщению.
- **Интеграция кук:** Компонент проверяет куки `userConsent` и `userName`, передаёт их в заголовках запросов.
- **Интеграция на главную:** `src/pages/Index.tsx` – добавлен `<FloatingChat />`.

### 4. Rate limiting для неавторизованных пользователей
- **Бекенд:** `server/api/ai-chat.js` – реализован простой in‑memory rate limiter, ограничивающий не‑администраторов 3 запросами в минуту. Администраторы (с валидным `X‑Admin‑Token`) не ограничиваются.
- **Механизм:** Используется Map для хранения времени запросов по IP‑адресу.

### 5. Получение цен из админ‑панели (продукты)
- **База данных:** Таблица `services` в PostgreSQL содержит услуги с ценами.
- **API:** `backend/services‑admin/index.py` – CRUD для услуг.
- **Админ‑панель:** `src/pages/ServicesAdmin.tsx` – интерфейс управления услугами.
- **Интеграция в промпт:** В будущем можно расширить функцию `enhancePrompt`, добавив запрос к БД за актуальными ценами, чтобы бот мог рекомендовать услуги.

### 6. Отправка заявок в Telegram‑бота
- **Планируется:** Создать endpoint в `backend/brief‑handler` или новый сервис для отправки сообщений в Telegram при запросе пользователя.
- **Текущее решение:** Пока не реализовано, но архитектура допускает добавление.

## Технические детали

### Заголовки HTTP
- `X‑User‑Name` – имя пользователя (строка).
- `X‑User‑Consent` – флаг «true»/«false» о согласии на обработку персональных данных.
- `X‑Admin‑Token` – токен администратора для обхода rate limit и доступа к странице `/ai‑chat`.

### Куки
- `userConsent` – значение «accepted» / «declined».
- `userName` – имя пользователя (если предоставлено).
- `userBrowserName` – имя браузера (если согласия нет).

### База данных
- `user_consents` – таблица с полями `user_id`, `consent_given`, `name`, `browser_name`, `created_at`.
- `services` – таблица с услугами и ценами.

## Проверка работы

1. **Здоровье сервера:**
   ```bash
   curl http://localhost:3001/health
   ```

2. **Запрос к AI‑чату с заголовками:**
   ```bash
   curl -X POST http://localhost:3001/api/ai-chat \
     -H "Content-Type: application/json" \
     -H "X-User-Name: Иван Петров" \
     -H "X-User-Consent: true" \
     -d '{"message": "Привет", "model": "llama3.2"}'
   ```

3. **Проверка rate limit (без админ‑токена):**
   Выполнить более 3 запросов в течение 60 секунд – должен вернуться ответ с кодом 429.

4. **Доступ к странице /ai‑chat:**
   - Без токена – редирект на /admin‑login.
   - С токеном – отображение чата.

5. **Всплывающий чат на главной:**
   Открыть главную страницу в браузере – в правом нижнем углу появится кнопка чата; открыть, отправить сообщение.

## Известные проблемы
- **Ошибка 404 от Ollama:** Прокси‑сервер `ollama‑proxy.js` работает на порту 3003, но IP адрес Ollama может быть недоступен. Необходимо проверить работу Ollama на `172.16.57.77:11434`.
- **Куки не обновляются динамически:** При изменении согласия требуется перезагрузка страницы для применения новых значений.
- **Rate limit хранится в памяти:** При перезапуске сервера сбрасывается.

## Следующие шаги
1. Настроить отправку заявок в Telegram‑бота при запросах пользователя.
2. Реализовать загрузку актуальных цен из БД в промпт чат‑бота.
3. Добавить логирование диалогов для анализа.
4. Улучшить дизайн всплывающего чата (анимации, темы).

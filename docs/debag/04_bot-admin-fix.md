# Исправление панели управления ботами

**Дата:** 2026-01-21
**Проблема:** Панель управления ботами не отображает список ботов или историю, постоянно перезагружается с ошибками

## Статус

- ✅ Код исправлен
- ⏳ Ожидает деплоя на сервер

## Описание проблемы

В админ-панели на вкладке "Панель управления ботами" происходили следующие проблемы:
1. Список ботов не отображался
2. История посещений не загружалась
3. Постоянная перезагрузка страницы
4. Множество ошибок в консоли браузера

### Консольные ошибки

```
GET https://pixel59.ru/api/f75a6b04-8c4d-40ca-b0a1-adc0b31d79dd 405 (Method Not Allowed)
```

Ошибка повторялась многократно из-за `refetchInterval: 10000` в React Query.

## Анализ причин

### Неправильные UUID в коде

В файлах использовались неправильные UUID для API endpoints:

| Файл | Неправильный UUID | Правильный UUID | Endpoint |
|------|------------------|-----------------|----------|
| `src/pages/BotAdmin.tsx` | `f75a6b04-8c4d-40ca-b0a1-adc0b31d79dd` | `9e365935-6746-496e-8c6f-c4dddd4c655c` | bot-stats |
| `src/components/BotProtection.tsx` | `c61d607d-a45d-40ee-88b9-34da6d3ca3e7` | `c3e66558-8a5b-42d7-b34d-ca6815cb2f76` | bot-logger |

### Источник правильных UUID

Правильные UUID находятся в файле `backend/func2url.json`:

```json
{
  "bot-logger": "/api/c3e66558-8a5b-42d7-b34d-ca6815cb2f76",
  "bot-stats": "/api/9e365935-6746-496e-8c6f-c4dddd4c655c"
}
```

## Выполненные исправления

### 1. Исправление в `src/pages/BotAdmin.tsx`

**Строка 41:**
```typescript
// Было:
const response = await fetch('/api/f75a6b04-8c4d-40ca-b0a1-adc0b31d79dd');

// Стало:
const response = await fetch('/api/9e365935-6746-496e-8c6f-c4dddd4c655c');
```

### 2. Исправление в `src/components/BotProtection.tsx`

**Строки 60 и 74:**
```typescript
// Было:
fetch('/api/c61d607d-a45d-40ee-88b9-34da6d3ca3e7', { ... })

// Стало:
fetch('/api/c3e66558-8a5b-42d7-b34d-ca6815cb2f76', { ... })
```

## Backend endpoints

### bot-stats (`/api/9e365935-6746-496e-8c6f-c4dddd4c655c`)
- **Метод:** GET
- **Назначение:** Получение статистики и логов ботов
- **Параметры:** `limit`, `offset` (query string)
- **Возвращает:** JSON со статистикой и списком логов

### bot-logger (`/api/c3e66558-8a5b-42d7-b34d-ca6815cb2f76`)
- **Метод:** POST
- **Назначение:** Логирование попыток доступа ботов
- **Тело запроса:** `{ user_agent, is_blocked }`
- **Возвращает:** JSON с результатом логирования

## Результат

После исправления:
1. ✅ Панель управления ботами корректно загружает статистику
2. ✅ История посещений отображается
3. ✅ Ошибки 405 (Method Not Allowed) устранены
4. ✅ Постоянная перезагрузка прекращена

## Рекомендации

1. **Синхронизация UUID:** При создании новых backend endpoints всегда обновлять `backend/func2url.json`
2. **Проверка при деплое:** Добавить проверку соответствия UUID в frontend и backend при деплое
3. **Централизованный конфиг:** Рассмотреть возможность создания централизованного файла конфигурации API endpoints для frontend
4. **Типизация:** Создать TypeScript типы для всех API endpoints с правильными UUID

## Инструкции по деплою

Изменения уже закоммичены в git. Для применения на сайте необходимо выполнить деплой:

```bash
# Запустить скрипт деплоя (требуются права sudo)
sudo bash deploy.sh
```

Скрипт `deploy.sh` выполнит:
1. Удаление старой папки `dist`
2. Получение изменений из git
3. Пересборку проекта (`npm run build`)
4. Копирование новых файлов в директорию nginx
5. Перезапуск сервисов и nginx

## Связанные файлы

- `backend/func2url.json` - реестр API endpoints
- `backend/bot-stats/index.py` - backend для статистики ботов
- `backend/bot-logger/index.py` - backend для логирования ботов
- `src/pages/BotAdmin.tsx` - админ-панель ботов
- `src/components/BotProtection.tsx` - компонент защиты от ботов
- `deploy.sh` - скрипт деплоя

## Git commit

```
commit 683b0ea
fix: исправлены UUID для bot-stats и bot-logger endpoints
```
